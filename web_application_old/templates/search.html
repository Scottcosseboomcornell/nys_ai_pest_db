<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesticide Database Search</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .nav-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-type {
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .search-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .select-button {
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 4px;
            min-width: 120px;
            text-align: center;
            font-weight: 500;
        }

        .select-button:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .select-button.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .select-button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            background: #f8f9fa;
        }

        .select-button-group.horizontal {
            flex-direction: row;
            flex-wrap: wrap;
            max-height: none;
        }

        .select-button-group.grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            max-height: none;
            overflow-y: visible;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .results-section {
            padding: 0 40px 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px 0;
            border-bottom: 2px solid #e9ecef;
        }

        .results-count {
            font-size: 1.2em;
            color: #495057;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .result-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .trade-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .epa-reg {
            font-size: 0.9em;
            color: #6c757d;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .organic-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .conventional-badge {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .result-details {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .active-ingredients {
            margin-top: 10px;
            font-size: 0.85em;
            color: #495057;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-results h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 80%;
            max-width: 1300px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-content-inner {
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
        }

        /* Custom scrollbar styling for modal */
        .modal-content-inner::-webkit-scrollbar {
            width: 12px;
        }

        .modal-content-inner::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 0 15px 15px 0;
        }

        .modal-content-inner::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
            border: 2px solid #f8f9fa;
            background-clip: padding-box;
        }

        .modal-content-inner::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
            border: 2px solid #f8f9fa;
            background-clip: padding-box;
        }

        .modal-content-inner::-webkit-scrollbar-corner {
            background: #f8f9fa;
            border-radius: 0 0 15px 0;
        }

        /* Firefox scrollbar styling */
        .modal-content-inner {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f8f9fa;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .pesticide-info {
            display: block;
            margin-bottom: 30px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 150px;
        }

        .info-value {
            color: #6c757d;
            text-align: right;
            flex: 1;
        }

        .application-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .application-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .application-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .application-table tr:hover {
            background-color: #f8f9fa;
        }

        .application-table tr:last-child td {
            border-bottom: none;
        }

        .no-application-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .loading-modal {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        /* All Pesticides Table Styles */
        .all-pesticides-section {
            padding: 40px;
            background: white;
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .section-header p {
            color: #6c757d;
            font-size: 1.1em;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .pesticides-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .pesticides-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pesticides-table th {
            background: #f8f9fa;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pesticides-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .pesticides-table tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        .pesticides-table tbody tr:last-child td {
            border-bottom: none;
        }

        .trade-name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .epa-cell {
            font-family: monospace;
            color: #6c757d;
        }

        .company-cell {
            color: #495057;
        }

        .ingredients-cell {
            color: #6c757d;
            font-size: 13px;
        }

        .rate-cell {
            color: #495057;
            font-weight: 500;
            font-size: 13px;
        }

        .phi-cell {
            color: #495057;
            font-weight: 500;
            font-size: 13px;
        }

        .label-cell {
            text-align: center;
            width: 50px;
        }

        .ingredient-group-summary {
            background-color: #f8f9fa !important;
            border-top: 2px solid #dee2e6 !important;
        }

        .ingredient-group-summary:hover {
            background-color: #e9ecef !important;
        }

        .ingredient-group-summary td {
            padding: 12px !important;
            color: #495057 !important;
            cursor: pointer !important;
        }

        .ingredient-group-summary .collapse-icon {
            display: inline-block;
            transition: transform 0.2s ease;
            font-size: 14px;
            color: #6c757d;
            font-weight: normal;
        }

        .ingredient-group-summary.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .ingredient-group-summary:hover .collapse-icon {
            color: #495057;
        }

        .ingredient-group-content {
            transition: all 0.3s ease;
        }

        .ingredient-group-content.collapsed {
            display: none;
        }

        .ingredient-group-content {
            background: white;
        }

        .ingredient-group-content:hover {
            background-color: #f8f9fa;
        }

        .single-product-row {
            background: white;
        }

        .single-product-row:hover {
            background-color: #f8f9fa;
        }

        .trade-name-cell, .ingredients-cell, .moa-cell, .rate-cell, .rei-cell, .phi-cell {
            cursor: pointer;
        }

        .label-link-btn {
            display: inline-block;
            padding: 6px 8px;
            font-size: 16px;
            text-decoration: none;
            color: #495057;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .label-link-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .load-more-info {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
            font-size: 14px;
        }

        .load-more-info p {
            margin: 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .pagination-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        #pageInfo {
            color: #495057;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .pesticide-info {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .application-table {
                font-size: 0.8em;
            }
            
            .application-table th,
            .application-table td {
                padding: 8px 6px;
            }

            /* Mobile table styles */
            .all-pesticides-section {
                padding: 20px;
            }

            .table-container {
                max-height: 500px;
            }

            .pesticides-table {
                font-size: 12px;
            }

            .pesticides-table th,
            .pesticides-table td {
                padding: 8px 6px;
            }

            .pesticides-table th:nth-child(3),
            .pesticides-table td:nth-child(3) {
                display: none; /* Hide company column on mobile */
            }

            .load-more-info {
                padding: 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="nav-link">‚Üê Back to Home</a>
            <h1>üåø Pesticide Database Search</h1>
            <p>Search through EPA pesticide registration data by EPA number, trade name, active ingredient, crop, or pest</p>
            <div class="nav-tabs">
                <a href="/pesticide-database" class="nav-tab active">Database</a>
                <a href="/pesticide-database/info" class="nav-tab">Info</a>
            </div>
        </div>

        <div class="search-section">
            <div style="background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <p style="color: #1976d2; font-size: 16px; margin: 0; line-height: 1.5;">
                    This pesticide database is automatically updated weekly with the latest actively registered pesticides in the US EPA database. A large language model was used to pull pesticide usage information from the PDF of each pesticide label along with crop-specific information for a selection of specialty crops.
                </p>
                <p style="color: #1976d2; font-size: 14px; margin: 0; line-height: 1.5;">
                    <strong>Crops Included:</strong> Apple, Blackberry, Blueberry, Grape, Cherry, Cranberry, Peach, Pear, Pecan, Strawberry, Spinach, Nectarine, Orange, Pepper, Tomato, Almond, Apricot, Potato, Raspberry, Walnut, Cucumber, Broccoli.
                </p>
                <p style="color: #1976d2; font-size: 14px; margin: 10px 0 0 0; line-height: 1.4;">
                    <strong>Future updates:</strong> refined pest list, state-specific pesticide names and labels.
                </p>
            </div>
            <div style="background-color: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center;">
                <p style="color: #d32f2f; font-weight: bold; font-size: 16px; margin: 0; line-height: 1.5;">
                    ‚ö†Ô∏è DISCLAIMER: This is a pesticide database built from AI interpretation of pesticide labels and may not be accurate. This information is not a substitute for pesticide labeling. Always read and understand the product label before using any pesticide.  
                </p>
            </div>
            <div class="stats-section" id="statsSection">
                <div class="stat-card">
                    <div class="stat-number" id="totalPesticides">-</div>
                    <div class="stat-label">Total Pesticides</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueIngredients">-</div>
                    <div class="stat-label">Active Ingredients</div>
                </div>
            </div>
        </div>

        <!-- Second Table Section (now first) -->
        <div class="results-section" style="margin-top: 40px; border-top: 3px solid #e9ecef; padding-top: 30px;">
            <div style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.4em;">Table 1: Filter by Crop, Pesticide Type, and Target</h3>
                <p style="color: #6c757d; font-size: 1em; margin-bottom: 15px;">Narrow results by crop, pesticide type, and target (grouped by active ingredient, sorted by mode of action)</p>
            </div>
            <div style="padding: 0 40px 20px;">
                <div style="margin-bottom: 20px;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight:600; margin-bottom:8px;">Step 1. Select Crop</div>
                        <div id="cropButtons" class="select-button-group grid">
                            <!-- Top 20 crops will be loaded here -->
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight:600; margin-bottom:8px;">Step 2. Select Target Type (Optional)</div>
                        <div id="targetTypeButtons" class="select-button-group grid">
                            <button class="select-button" data-type="Disease">Disease</button>
                            <button class="select-button" data-type="Insect">Insect</button>
                            <button class="select-button" data-type="Weed">Weed</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight:600; margin-bottom:8px;">Step 3. Select Target</div>
                        <div id="targetButtons" class="select-button-group horizontal">
                            <!-- Top 10 targets will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Apply button removed; filtering triggers automatically on selection -->
                </div>
                <div id="filterStatus" style="color:#6c757d; margin-bottom: 10px; font-size: 0.9em; font-style: italic;"></div>
                <div class="table-container">
                    <table class="pesticides-table" id="filteredPesticidesTable">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>EPA Label</th>
                                <th>Active Ingredients</th>
                                <th>Trade Name</th>
                                <th>Mode of Action</th>
                                <th>Rate Range</th>
                                <th>REI (hours)</th>
                                <th>PHI</th>
                            </tr>
                        </thead>
                        <tbody id="filteredPesticidesTableBody"></tbody>
                    </table>
                    <div style="text-align:center; padding: 14px;">
                        <button id="loadMoreFilterBtn" class="search-button" style="display:none;">Load more</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button id="downloadFilteredBtn" class="search-button" style="background: #007bff;" onclick="downloadFilteredResults()">Download Results</button>
                </div>
            </div>
        </div>

        <!-- First Table Section (now second) -->
        <div class="results-section" style="margin-top: 40px; border-top: 3px solid #e9ecef; padding-top: 30px;">
            <div style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.4em;">Table 2: Search All Pesticides in the Database</h3>
                <p style="color: #6c757d; font-size: 1em; margin-bottom: 15px;">Click a pesticide to see more details.</p>
            </div>

            <form class="search-form" id="searchForm" style="margin-bottom: 20px;">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search pesticides by any detail (EPA number, trade name, ingredient, crop, pest, company, etc.)..."
                    autocomplete="off"
                >
                <button type="submit" class="search-button">üîç Search</button>
            </form>

            <div style="margin-bottom: 15px;">
                <div class="results-count" id="resultsCount" style="font-size: 0.9em; color: #6c757d; font-style: italic;">Status: Showing all pesticides</div>
            </div>
            
            <div class="table-container">
                <table class="pesticides-table" id="pesticidesTable">
                    <thead>
                        <tr>
                            <th>EPA Label</th>
                            <th>Trade Name</th>
                            <th>EPA Registration Number</th>
                            <th>Company</th>
                            <th>Active Ingredients</th>
                            <th>Mode of Action</th>
                            <th>REI (hours)</th>
                        </tr>
                    </thead>
                    <tbody id="pesticidesTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                
                <div class="loading-spinner" id="tableLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading more pesticides...</p>
                </div>
                
                <div class="load-more-info" id="loadMoreInfo" style="display: none;">
                    <p>Scroll down to load more pesticides</p>
                </div>
            </div>
        </div>

        <!-- Last Updated Section -->
        <div style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e9ecef; color: #6c757d; font-size: 0.9em;">
            {% if last_updated %}
            <p style="margin: 0;">
                üìÖ Last Updated: {{ last_updated|datetime }}
            </p>
            {% endif %}
        </div>

        </div>
    </div>

    <!-- Modal for detailed pesticide information -->
    <div id="myModal" class="modal">
        <div class="modal-content" id="modalContent">
            <!-- Modal content will be loaded here -->
        </div>
    </div>

    <script>
        // Load statistics on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadLastUpdated();
            initGuidedFilter();
            // Show initial loading state
            const tbody = document.getElementById('pesticidesTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Loading pesticide database...</p>
                        <p style="font-size: 12px; margin-top: 10px;">This may take a few seconds for the first load</p>
                    </td>
                </tr>
            `;
            loadPesticidesTable();
        });

        // Table infinite scroll variables
        let currentPage = 1;
        const perPage = 50;
        let isLoading = false;
        let hasMoreData = true;
        let allPesticides = [];
        let filteredPesticides = [];
        let isFiltered = false;
        let initialLoadComplete = false;
        // Search pagination state
        let searchPage = 1;
        let searchPerPage = 200; // fetch larger chunks for searches
        let currentSearchQuery = '';
        let currentSearchType = 'both';
        let currentSearchTotal = 0;
        let currentSearchHasNext = false;

        // Guided filter pagination state
        let filterPage = 1;
        let filterPerPage = 10000;
        let filterHasNext = false;
        let selectedCrop = '';
        let selectedPestCat = '';
        let selectedTargetType = '';
        window.selectedTargetType = '';
        let selectedPest = '';
 
        // Search form handling
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            filterTable();
        });

        // Real-time search filtering with debounce
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterTable();
            }, 300); // 300ms delay to prevent too many API calls
        });

        function loadStats() {
            const startTime = performance.now();
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalPesticides').textContent = data.total_pesticides;
                    document.getElementById('uniqueIngredients').textContent = data.unique_ingredients;
                    const loadTime = performance.now() - startTime;
                    console.log(`Stats loaded in ${loadTime.toFixed(2)}ms`);
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        function loadLastUpdated() {
            fetch('/api/last-updated')
                .then(response => response.json())
                .then(data => {
                    if (data.formatted) {
                        updateLastUpdated(data.formatted);
                    }
                })
                .catch(error => {
                    console.error('Error loading last updated timestamp:', error);
                });
        }

        function updateLastUpdated(formattedTimestamp) {
            const lastUpdatedElement = document.querySelector('div[style*="Last Updated Section"] p');
            if (lastUpdatedElement) {
                lastUpdatedElement.innerHTML = `üìÖ Last Updated: ${formattedTimestamp}`;
            }
        }

        // Update timestamp every 5 minutes
        setInterval(loadLastUpdated, 5 * 60 * 1000);

        function filterTable() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                // Show all pesticides
                isFiltered = false;
                filteredPesticides = [];
                resetTable();
                document.getElementById('resultsCount').textContent = 'Status: Showing all pesticides';
                return;
            }

            // Show loading state
            const tbody = document.getElementById('pesticidesTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Searching through ${initialLoadComplete ? allPesticides.length : 'all'} pesticides...</p>
                    </td>
                </tr>
            `;

            // Initialize search pagination
            searchPage = 1;
            searchPerPage = 200;
            currentSearchQuery = query;
            currentSearchType = 'both'; // Always use global search

            // Search with pagination (always use global search)
            fetch(`/api/search?q=${encodeURIComponent(query)}&type=both&page=${searchPage}&per_page=${searchPerPage}`)
                .then(response => response.json())
                .then(data => {
                    isFiltered = true;
                    filteredPesticides = data.pesticides || [];
                    currentSearchTotal = data.total || filteredPesticides.length;
                    currentSearchHasNext = (data.pagination && data.pagination.has_next) || false;
                    displayFilteredResults(data, query);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                <h3>‚ùå Search Error</h3>
                                <p>An error occurred while searching. Please try again.</p>
                                <button onclick="filterTable()" class="search-button" style="margin-top: 10px;">Retry Search</button>
                            </td>
                        </tr>
                    `;
                    document.getElementById('resultsCount').textContent = 'Status: Search error';
                });
        }

        function displayFilteredResults(data, query) {
            const tbody = document.getElementById('pesticidesTableBody');
            const resultsCount = document.getElementById('resultsCount');
            const results = filteredPesticides;

            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                            <h3>üîç No Results Found</h3>
                            <p>No pesticides found matching "${query}". Try a different search term.</p>
                        </td>
                    </tr>
                `;
                resultsCount.textContent = 'Status: No results found';
                return;
            }

            const total = currentSearchTotal || results.length;
            resultsCount.textContent = `Status: Found ${total} result${total > 1 ? 's' : ''} for "${query}"${results.length < total ? ` (showing ${results.length})` : ''}`;

            let rows = results.map(pesticide => {
                // Mode of Action list (unique, comma-separated)
                const moaSet = new Set((pesticide.active_ingredients || []).map(ing => (ing.mode_Of_Action || '?')).filter(Boolean));
                const moa = Array.from(moaSet).filter(v => v && v !== '?' && v !== 'N/A').join(', ') || '?';

                // REI extraction: collect numeric hours when possible; else pick distinct values
                const reiValues = (pesticide.application_info || []).map(app => app.REI).filter(Boolean);
                const reiNumeric = reiValues
                    .map(v => {
                        const m = String(v).match(/\d+(?:\.\d+)?/);
                        return m ? Number(m[0]) : null;
                    })
                    .filter(v => v !== null);
                let reiDisplay = '?';
                if (reiNumeric.length > 0) {
                    const min = Math.min(...reiNumeric);
                    const max = Math.max(...reiNumeric);
                    reiDisplay = min === max ? String(min) : 'Varies by crop';
                } else if (reiValues.length > 0) {
                    const distinct = Array.from(new Set(reiValues));
                    reiDisplay = distinct.length === 1 ? (distinct[0] === 'N/A' ? '?' : distinct[0]) : 'Varies by crop';
                }

                return `
                <tr onclick="showPesticideDetails('${pesticide.epa_reg_no}')">
                    <td class="label-cell" onclick="event.stopPropagation();">
                        <a href="${pesticide.label_url || '#'}" target="_blank" class="label-link-btn" ${!pesticide.label_url ? 'style="pointer-events: none; opacity: 0.5;"' : ''}>
                            üè∑Ô∏è
                        </a>
                    </td>
                    <td class="trade-name-cell">${pesticide.trade_Name}</td>
                    <td class="epa-cell">${pesticide.epa_reg_no}</td>
                    <td class="company-cell">${pesticide.COMPANY_NAME}</td>
                    <td class="ingredients-cell">
                        ${pesticide.active_ingredients && pesticide.active_ingredients.length > 0 ? 
                            pesticide.active_ingredients.map(ing => ing.name).join(', ') : '?'}
                    </td>
                    <td class="moa-cell">${moa}</td>
                    <td class="rei-cell">${reiDisplay}</td>
                </tr>
            `;
            }).join('');

            // Add Load More row if there are more pages
            if (currentSearchHasNext) {
                rows += `
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 20px;">
                            <button id="loadMoreSearchBtn" class="search-button">Load more results</button>
                        </td>
                    </tr>`;
            }

            tbody.innerHTML = rows;

            // Wire up Load More
            const btn = document.getElementById('loadMoreSearchBtn');
            if (btn) {
                btn.addEventListener('click', loadMoreSearch);
            }
        }

        function loadMoreSearch() {
            // Fetch next page and append
            const tbody = document.getElementById('pesticidesTableBody');
            // Replace button with loading state
            const btn = document.getElementById('loadMoreSearchBtn');
            if (btn) btn.textContent = 'Loading...';

            searchPage += 1;
            fetch(`/api/search?q=${encodeURIComponent(currentSearchQuery)}&type=both&page=${searchPage}&per_page=${searchPerPage}`)
                .then(r => r.json())
                .then(data => {
                    const newResults = data.pesticides || [];
                    filteredPesticides = filteredPesticides.concat(newResults);
                    currentSearchHasNext = (data.pagination && data.pagination.has_next) || false;
                    currentSearchTotal = data.total || currentSearchTotal;

                    // Re-render list with accumulated results
                    displayFilteredResults(data, currentSearchQuery);
                })
                .catch(err => {
                    console.error('Load more error:', err);
                    if (btn) btn.textContent = 'Load more results';
                });
        }

        function resetTable() {
            // Reset to show all loaded pesticides
            const tbody = document.getElementById('pesticidesTableBody');
            if (allPesticides.length > 0) {
                const rows = allPesticides.map(pesticide => {
                    const moaSet = new Set((pesticide.active_ingredients || []).map(ing => (ing.mode_Of_Action || '?')).filter(Boolean));
                    const moa = Array.from(moaSet).filter(v => v && v !== '?' && v !== 'N/A').join(', ') || '?';
                    const reiValues = (pesticide.application_info || []).map(app => app.REI).filter(Boolean);
                    const reiNumeric = reiValues
                        .map(v => { const m = String(v).match(/\d+(?:\.\d+)?/); return m ? Number(m[0]) : null; })
                        .filter(v => v !== null);
                    let reiDisplay = '?';
                    if (reiNumeric.length > 0) {
                        const min = Math.min(...reiNumeric);
                        const max = Math.max(...reiNumeric);
                        reiDisplay = min === max ? String(min) : 'Varies by crop';
                    } else if (reiValues.length > 0) {
                        const distinct = Array.from(new Set(reiValues));
                        reiDisplay = distinct.length === 1 ? (distinct[0] === 'N/A' ? '?' : distinct[0]) : 'Varies by crop';
                    }
                    return `
                    <tr onclick="showPesticideDetails('${pesticide.epa_reg_no}')">
                        <td class="label-cell" onclick="event.stopPropagation();">
                            <a href="${pesticide.label_url || '#'}" target="_blank" class="label-link-btn" ${!pesticide.label_url ? 'style="pointer-events: none; opacity: 0.5;"' : ''}>
                                üè∑Ô∏è
                            </a>
                        </td>
                        <td class="trade-name-cell">${pesticide.trade_Name}</td>
                        <td class="epa-cell">${pesticide.epa_reg_no}</td>
                        <td class="company-cell">${pesticide.COMPANY_NAME}</td>
                        <td class="ingredients-cell">
                            ${pesticide.active_ingredients && pesticide.active_ingredients.length > 0 ? 
                                pesticide.active_ingredients.map(ing => ing.name).join(', ') : '?'}
                        </td>
                        <td class="moa-cell">${moa}</td>
                        <td class="rei-cell">${reiDisplay}</td>
                    </tr>
                `;
                }).join('');
                tbody.innerHTML = rows;
            } else {
                // If no pesticides are loaded yet, show loading message
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                            <div class="loading-spinner" style="display: inline-block;">
                                <div class="spinner"></div>
                            </div>
                            <p>Loading pesticides...</p>
                        </td>
                    </tr>
                `;
            }
        }

        function showPesticideDetails(epaRegNo) {
            const modal = document.getElementById('myModal');
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <div class="loading-modal">
                    <h3>Loading...</h3>
                    <p>Fetching detailed information...</p>
                </div>
            `;
            modal.style.display = 'block';

            fetch(`/api/pesticide/${epaRegNo}`)
                .then(response => response.json())
                .then(pesticide => {
                    if (pesticide.error) {
                        throw new Error(pesticide.error);
                    }

                    // Build grouped application rows: same crop/rates/units/REI/PHI merged with diseases comma-separated
                    let rowsHtml = '';
                    if (pesticide.application_info && pesticide.application_info.length > 0) {
                        const grouped = {};
                        for (const app of pesticide.application_info) {
                            const key = JSON.stringify([
                                app.Target_Crop || '',
                                app.low_rate ?? '',
                                app.high_rate ?? '',
                                app.units || '',
                                app.REI || '',
                                app.PHI || ''
                            ]);
                            if (!grouped[key]) {
                                grouped[key] = {
                                    Target_Crop: app.Target_Crop || 'N/A',
                                    low_rate: app.low_rate ?? 'N/A',
                                    high_rate: app.high_rate ?? 'N/A',
                                    units: app.units || 'N/A',
                                    REI: app.REI || '?',
                                    PHI: app.PHI || '?',
                                    diseases: []
                                };
                            }
                            const disease = app.Target_Disease_Pest || 'N/A';
                            if (disease) grouped[key].diseases.push(disease);
                        }
                        const groupedRows = Object.values(grouped).map(g => {
                            const uniqueDiseases = Array.from(new Set(g.diseases)).filter(Boolean);
                            
                            // Combine rate information
                            let rateDisplay = 'N/A';
                            if (g.low_rate !== 'N/A' && g.low_rate !== '?' && g.high_rate !== 'N/A' && g.high_rate !== '?') {
                                const lowRate = parseFloat(g.low_rate);
                                const highRate = parseFloat(g.high_rate);
                                const units = g.units || '';
                                
                                if (!isNaN(lowRate) && !isNaN(highRate)) {
                                    if (lowRate === highRate) {
                                        rateDisplay = `${g.low_rate} ${units}`;
                                    } else {
                                        rateDisplay = `${g.low_rate}-${g.high_rate} ${units}`;
                                    }
                                } else {
                                    // Fallback if parsing fails
                                    if (g.low_rate === g.high_rate) {
                                        rateDisplay = `${g.low_rate} ${units}`;
                                    } else {
                                        rateDisplay = `${g.low_rate}-${g.high_rate} ${units}`;
                                    }
                                }
                            } else if (g.low_rate !== 'N/A' && g.low_rate !== '?') {
                                rateDisplay = `${g.low_rate} ${g.units || ''}`;
                            } else if (g.high_rate !== 'N/A' && g.high_rate !== '?') {
                                rateDisplay = `${g.high_rate} ${g.units || ''}`;
                            }
                            
                            return {
                                Target_Crop: g.Target_Crop,
                                Target_Disease_Pest: uniqueDiseases.join(', '),
                                Rate: rateDisplay.trim(),
                                REI: g.REI,
                                PHI: g.PHI
                            };
                        });
                        
                        // Sort rows alphabetically by target crop first, then by target disease/pest
                        groupedRows.sort((a, b) => {
                            const cropA = (a.Target_Crop || '').toLowerCase();
                            const cropB = (b.Target_Crop || '').toLowerCase();
                            
                            if (cropA !== cropB) {
                                return cropA.localeCompare(cropB);
                            }
                            
                            // If crops are the same, sort by target disease/pest
                            const diseaseA = (a.Target_Disease_Pest || '').toLowerCase();
                            const diseaseB = (b.Target_Disease_Pest || '').toLowerCase();
                            return diseaseA.localeCompare(diseaseB);
                        });
                        
                        rowsHtml = groupedRows.map(gr => `
                            <tr>
                                <td>${gr.Target_Crop}</td>
                                <td>${gr.Target_Disease_Pest}</td>
                                <td>${gr.Rate}</td>
                                <td>${gr.REI === 'N/A' ? '?' : gr.REI}</td>
                                <td>${gr.PHI === 'N/A' ? '?' : gr.PHI}</td>
                            </tr>
                        `).join('');
                    }

                    modalContent.innerHTML = `
                        <div class="modal-content-inner">
                            <div class="modal-header">
                                <div style="flex: 1;">
                                    <h2 class="modal-title">${pesticide.trade_Name}</h2>
                                    ${(() => {
                                        // Parse alternative names and filter out primary name
                                        if (!pesticide.ABNS || pesticide.ABNS === 'N/A') return '';
                                        
                                        const names = pesticide.ABNS.split(',').map(name => name.trim());
                                        const alternatives = names.filter(name => 
                                            !name.includes('(Primary Name)') && 
                                            name !== pesticide.trade_Name
                                        );
                                        
                                        if (alternatives.length === 0) return '';
                                        
                                        return `
                                            <div style="font-size: 1em; opacity: 0.8; margin-top: 5px; font-weight: 300;">
                                                Alternative Names: ${alternatives.join(', ')}
                                            </div>
                                        `;
                                    })()}
                                </div>
                                <span class="close" onclick="closeModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                <div style="padding: 20px 0; text-align: center; border-bottom: 1px solid #e9ecef; margin-bottom: 20px;">
                                    <a href="${pesticide.label_url}" target="_blank" class="search-button" style="text-decoration:none; margin-right: 10px;">Latest EPA Label PDF</a>
                                    <a href="/api/pesticide/${pesticide.epa_reg_no}/download" class="search-button" style="text-decoration:none; background: #28a745;">Download This Page</a>
                                </div>
                                <div class="pesticide-info">
                                    <div class="info-section">
                                        <h3>Basic Information</h3>
                                        <div class="info-item">
                                            <div class="info-label">EPA Registration Number:</div>
                                            <div class="info-value">${pesticide.epa_reg_no}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Trade Name:</div>
                                            <div class="info-value">${pesticide.trade_Name}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Active Ingredient:</div>
                                            <div class="info-value">
                                                ${pesticide.active_ingredients.length > 0 ?
                                                    pesticide.active_ingredients.map(ing => ing.name).join(', ') : '?'}
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">AI (%):</div>
                                            <div class="info-value">
                                                ${pesticide.active_ingredients.length > 0 ?
                                                    pesticide.active_ingredients.map(ing => 
                                                        ing.percentage || '?'
                                                    ).join(', ') : '?'}
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Mode of action:</div>
                                            <div class="info-value">
                                                ${pesticide.active_ingredients.length > 0 ?
                                                    pesticide.active_ingredients.map(ing => 
                                                        ing.mode_Of_Action || '?'
                                                    ).join(', ') : '?'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="info-section">
                                        <h3>Additional Information</h3>
                                        <div class="info-item">
                                            <div class="info-label">PPE:</div>
                                            <div class="info-value">${pesticide.PPE || '?'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Signal Word:</div>
                                            <div class="info-value">${pesticide.CAUTION_statement || '?'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Company:</div>
                                            <div class="info-value">${pesticide.COMPANY_NAME || '?'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">First Registration Date:</div>
                                            <div class="info-value">${(() => {
                                                if (pesticide.Safety_Information && pesticide.Safety_Information.FIRST_REG_DT) {
                                                    // Format date from YYYY-MM-DD to MM/DD/YYYY
                                                    const dateStr = pesticide.Safety_Information.FIRST_REG_DT;
                                                    const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                                                    if (match) {
                                                        const year = match[1];
                                                        const month = match[2];
                                                        const day = match[3];
                                                        return `${month}/${day}/${year}`;
                                                    }
                                                    return dateStr; // Return original if format doesn't match
                                                }
                                                return '?';
                                            })()}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Physical Form:</div>
                                            <div class="info-value">${(() => {
                                                if (pesticide.Safety_Information && pesticide.Safety_Information.PHYS_FORM) {
                                                    return pesticide.Safety_Information.PHYS_FORM;
                                                }
                                                return '?';
                                            })()}</div>
                                        </div>
                                        ${(() => {
                                            // Show label names if they exist
                                            const labelNames = pesticide.Safety_Information && pesticide.Safety_Information.LABEL_NAMES;
                                            if (!labelNames || !Array.isArray(labelNames) || labelNames.length === 0) return '';
                                            
                                            // Function to format date from filename
                                            function formatDateFromFilename(filename) {
                                                // Extract the date part (last 8 digits before .pdf)
                                                const match = filename.match(/(\d{8})\.pdf$/);
                                                if (!match) return filename; // Return original if no date found
                                                
                                                const dateStr = match[1];
                                                const year = dateStr.substring(0, 4);
                                                const month = dateStr.substring(4, 6);
                                                const day = dateStr.substring(6, 8);
                                                
                                                // Format as MM/DD/YYYY
                                                return `${month}/${day}/${year}`;
                                            }
                                            
                                            // Create links for each label
                                            const labelLinks = labelNames.map(filename => {
                                                const formattedDate = formatDateFromFilename(filename);
                                                const url = `https://www3.epa.gov/pesticides/chem_search/ppls/${filename}`;
                                                return `<a href="${url}" target="_blank" style="color: #667eea; text-decoration: none; margin-right: 10px; padding: 4px 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; transition: all 0.2s ease;" onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#667eea';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e9ecef';">${formattedDate}</a>`;
                                            }).join('');
                                            
                                            return `
                                                <div class="info-item">
                                                    <div class="info-label">All EPA Labels:</div>
                                                    <div class="info-value" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                                        ${labelLinks}
                                                    </div>
                                                </div>
                                            `;
                                        })()}
                
                                    </div>
                                </div>
                                
                                <h3>Application Information</h3>
                                ${(rowsHtml && rowsHtml.length > 0) ?
                                    `<table class="application-table">
                                        <thead>
                                            <tr>
                                                <th>Crop</th>
                                                <th>Target</th>
                                                <th>Rate</th>
                                                <th>REI</th>
                                                <th>PHI</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${rowsHtml}
                                        </tbody>
                                    </table>` :
                                    `<div class="no-application-data">No application data available for this pesticide.</div>`
                                }
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching pesticide details:', error);
                    modalContent.innerHTML = `
                        <div class="modal-content-inner">
                            <div class="modal-header">
                                <h2 class="modal-title">Error</h2>
                                <span class="close" onclick="closeModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                <p>Could not load detailed information for this pesticide: ${error.message}</p>
                            </div>
                            <div style="padding: 20px 30px; text-align: center; border-top: 1px solid #e9ecef;">
                                <button class="search-button" onclick="closeModal()">Close</button>
                            </div>
                        </div>
                    `;
                });
        }

        function closeModal() {
            const modal = document.getElementById('myModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside the modal content
        window.onclick = function(event) {
            const modal = document.getElementById('myModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Table infinite scroll functions
        function loadPesticidesTable() {
            if (isLoading || !hasMoreData) return;
            
            isLoading = true;
            // Only show loading indicator if this is not the first load (initial load already has its own indicator)
            if (initialLoadComplete) {
                showTableLoading();
            }
            
            const startTime = performance.now();
            fetch(`/api/pesticides?page=${currentPage}&per_page=${perPage}`)
                .then(response => response.json())
                .then(data => {
                    const loadTime = performance.now() - startTime;
                    console.log(`Page ${currentPage} loaded in ${loadTime.toFixed(2)}ms`);
                    
                    appendPesticidesToTable(data.pesticides);
                    hasMoreData = data.pagination.has_next;
                    currentPage++;
                    hideTableLoading();
                    isLoading = false;
                    initialLoadComplete = true;
                    
                    if (!hasMoreData) {
                        hideLoadMoreInfo();
                    } else {
                        showLoadMoreInfo();
                    }
                })
                .catch(error => {
                    console.error('Error loading pesticides table:', error);
                    hideTableLoading();
                    isLoading = false;
                    document.getElementById('pesticidesTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                <h3>‚ùå Loading Error</h3>
                                <p>Error loading pesticides. Please refresh the page to try again.</p>
                                <button onclick="location.reload()" class="search-button" style="margin-top: 10px;">Refresh Page</button>
                            </td>
                        </tr>
                    `;
                });
        }

        function appendPesticidesToTable(pesticides) {
            const tbody = document.getElementById('pesticidesTableBody');
            
            if (pesticides.length === 0) {
                if (currentPage === 1) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                No pesticides found.
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            // Store pesticides in the allPesticides array for filtering
            allPesticides = allPesticides.concat(pesticides);

            const rows = pesticides.map(pesticide => {
                const moaSet = new Set((pesticide.active_ingredients || []).map(ing => (ing.mode_Of_Action || '?')).filter(Boolean));
                const moa = Array.from(moaSet).filter(v => v && v !== '?' && v !== 'N/A').join(', ') || '?';
                const reiValues = (pesticide.application_info || []).map(app => app.REI).filter(Boolean);
                const reiNumeric = reiValues
                    .map(v => { const m = String(v).match(/\d+(?:\.\d+)?/); return m ? Number(m[0]) : null; })
                    .filter(v => v !== null);
                let reiDisplay = '?';
                if (reiNumeric.length > 0) {
                    const min = Math.min(...reiNumeric);
                    const max = Math.max(...reiNumeric);
                    reiDisplay = min === max ? String(min) : 'Varies by crop';
                } else if (reiValues.length > 0) {
                    const distinct = Array.from(new Set(reiValues));
                    reiDisplay = distinct.length === 1 ? (distinct[0] === 'N/A' ? '?' : distinct[0]) : 'Varies by crop';
                }
                return `
                    <tr onclick="showPesticideDetails('${pesticide.epa_reg_no}')">
                        <td class="label-cell" onclick="event.stopPropagation();">
                            <a href="${pesticide.label_url || '#'}" target="_blank" class="label-link-btn" ${!pesticide.label_url ? 'style="pointer-events: none; opacity: 0.5;"' : ''}>
                                üè∑Ô∏è
                            </a>
                        </td>
                        <td class="trade-name-cell">${pesticide.trade_Name}</td>
                        <td class="epa-cell">${pesticide.epa_reg_no}</td>
                        <td class="company-cell">${pesticide.COMPANY_NAME}</td>
                        <td class="ingredients-cell">
                            ${pesticide.active_ingredients && pesticide.active_ingredients.length > 0 ? 
                                pesticide.active_ingredients.map(ing => ing.name).join(', ') : '?'}
                        </td>
                        <td class="moa-cell">${moa}</td>
                        <td class="rei-cell">${reiDisplay}</td>
                    </tr>
                `;
            }).join('');

            if (currentPage === 1) {
                tbody.innerHTML = rows;
            } else {
                tbody.insertAdjacentHTML('beforeend', rows);
            }
        }

        function showTableLoading() {
            document.getElementById('tableLoading').style.display = 'block';
            document.getElementById('loadMoreInfo').style.display = 'none';
        }

        function hideTableLoading() {
            document.getElementById('tableLoading').style.display = 'none';
        }

        function showLoadMoreInfo() {
            document.getElementById('loadMoreInfo').style.display = 'block';
        }

        function hideLoadMoreInfo() {
            document.getElementById('loadMoreInfo').style.display = 'none';
        }

        // Infinite scroll event listener
        function handleScroll() {
            const tableContainer = document.querySelector('.table-container');
            if (!tableContainer) return;
            
            const scrollTop = tableContainer.scrollTop;
            const scrollHeight = tableContainer.scrollHeight;
            const clientHeight = tableContainer.clientHeight;
            
            // Only load more if not filtering and user scrolls to bottom (with 100px threshold)
            if (scrollHeight - scrollTop - clientHeight < 100 && !isLoading && hasMoreData && !isFiltered) {
                loadPesticidesTable();
            }
        }

        // Add scroll event listener to table container
        document.addEventListener('DOMContentLoaded', function() {
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.addEventListener('scroll', handleScroll);
            }
        });


        // Function to load top 20 crops in alphabetical order
        function loadTopCrops() {
            const cropButtons = document.getElementById('cropButtons');
            
            fetch('/api/enums/crops')
                .then(r => r.json())
                .then(data => {
                    const crops = data.crops || [];
                    // Sort alphabetically and take top 20
                    const sortedCrops = crops.sort().slice(0, 20);
                    
                    cropButtons.innerHTML = sortedCrops.map(crop => 
                        `<button class="select-button" data-crop="${crop}">${crop}</button>`
                    ).join('');
                    
                    // Add click handlers for crop buttons
                    cropButtons.querySelectorAll('.select-button').forEach(button => {
                        button.addEventListener('click', () => {
                            // Remove selected class from all buttons
                            cropButtons.querySelectorAll('.select-button').forEach(b => b.classList.remove('selected'));
                            // Add selected class to clicked button
                            button.classList.add('selected');
                            // Update selected crop
                            selectedCrop = button.dataset.crop;
                            // Load targets for the selected crop
                            loadTopTargets();
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading crops:', error);
                    cropButtons.innerHTML = '<div style="color: #dc3545; padding: 20px; text-align: center;">Error loading crops</div>';
                });
        }

        // Function to load top 10 targets for the selected crop and target type
        function loadTopTargets() {
            const targetButtons = document.getElementById('targetButtons');
            const status = document.getElementById('filterStatus');
            
            if (!selectedCrop) {
                targetButtons.innerHTML = '<div style="color: #6c757d; padding: 20px; text-align: center;">Select a crop first...</div>';
                return;
            }
            
            // Ensure a stable target type: prefer selected button, then window var, then default to 'Disease'
            const selectedBtn = document.querySelector('#targetTypeButtons .select-button.selected');
            let effectiveTargetType = (selectedBtn && selectedBtn.dataset.type) || window.selectedTargetType || selectedTargetType || 'Disease';
            // If no button is selected (e.g., after reload), select the first and set globals
            if (!selectedBtn) {
                const firstTypeBtn = document.querySelector('#targetTypeButtons .select-button');
                if (firstTypeBtn) {
                    firstTypeBtn.classList.add('selected');
                    effectiveTargetType = firstTypeBtn.dataset.type || 'Disease';
                    selectedTargetType = effectiveTargetType;
                    window.selectedTargetType = effectiveTargetType;
                }
            }
            let url = `/api/enums/pests?crop=${encodeURIComponent(selectedCrop)}`;
            if (effectiveTargetType) {
                url += `&target_type=${encodeURIComponent(effectiveTargetType)}`;
            }
            
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const pests = data.pests || [];
                    // Sort by count (extract number from parentheses) and take top 10
                    const sortedPests = pests
                        .map(p => {
                            const match = p.match(/^(.+?) \((\d+)\)$/);
                            return match ? { name: match[1], count: parseInt(match[2]), display: match[1] } : { name: p, count: 0, display: p };
                        })
                        .sort((a, b) => b.count - a.count)
                        .slice(0, 10);
                    
                    targetButtons.innerHTML = sortedPests.map(p => 
                        `<button class="select-button" data-target="${p.name}">${p.display}</button>`
                    ).join('');
                    
                    // Add click handlers for target buttons
                    targetButtons.querySelectorAll('.select-button').forEach(button => {
                        button.addEventListener('click', () => {
                            // Remove selected class from all buttons
                            targetButtons.querySelectorAll('.select-button').forEach(b => b.classList.remove('selected'));
                            // Add selected class to clicked button
                            button.classList.add('selected');
                            // Update selected pest
                            selectedPest = button.dataset.target;
                            // Auto-apply filter when a target is selected
                            if (window.applyFilter) {
                                window.applyFilter();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading targets:', error);
                    targetButtons.innerHTML = '<div style="color: #dc3545; padding: 20px; text-align: center;">Error loading targets</div>';
                    status.textContent = 'Status: Error loading target list.';
                });
        }

        // Guided filter logic
        function initGuidedFilter() {
            const targetTypeButtons = document.getElementById('targetTypeButtons');
            const targetButtons = document.getElementById('targetButtons');
            const status = document.getElementById('filterStatus');
            const loadMoreBtn = document.getElementById('loadMoreFilterBtn');

            // Load crops using the new button interface
            loadTopCrops();

            // After crops are loaded, auto-select first crop, first target type, and first target
            // Defer to allow buttons to render
            setTimeout(() => {
                const cropButtons = document.getElementById('cropButtons');
                const firstCropBtn = cropButtons && cropButtons.querySelector('.select-button');
                if (firstCropBtn) {
                    firstCropBtn.click();
                }
                // Auto-select first target type button (Disease)
                const firstTypeBtn = document.querySelector('#targetTypeButtons .select-button');
                if (firstTypeBtn) {
                    firstTypeBtn.click();
                }
                // Wait a bit for targets to load, then click the first target
                setTimeout(() => {
                    const firstTargetBtn = document.querySelector('#targetButtons .select-button');
                    if (firstTargetBtn) {
                        firstTargetBtn.click();
                    }
                }, 600);
            }, 600);
            
            // Initialize target type buttons (already in HTML)
            // Add click handlers for target type buttons
            targetTypeButtons.querySelectorAll('.select-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Always keep exactly one selected (no toggle-off to blank)
                    targetTypeButtons.querySelectorAll('.select-button').forEach(b => b.classList.remove('selected'));
                    button.classList.add('selected');
                    // Update selected target type and persist on window
                    selectedTargetType = button.dataset.type;
                    window.selectedTargetType = selectedTargetType;
                    // Reload targets
                    loadTopTargets();
                });
            });

            // Global applyFilter function (used by target click and auto-init)
            window.applyFilter = function() {
                filterPage = 1;
                filterPerPage = 10000;
                const selectionText = `${selectedCrop} ${selectedTargetType}: ${selectedPest}`;
                status.textContent = `Status: Loading filtered pesticides for ${selectionText}...`;
                loadMoreBtn.style.display = 'none';
                fetch(`/api/filter?crop=${encodeURIComponent(selectedCrop)}&target_type=${encodeURIComponent(selectedTargetType)}&pest=${encodeURIComponent(selectedPest)}&page=${filterPage}&per_page=${filterPerPage}`)
                    .then(r => r.json())
                    .then(data => {
                        filteredPesticides = (data.pesticides || []).slice();
                        renderFilteredTable(filteredPesticides);
                        filterHasNext = false;
                        const resultCount = data.total || filteredPesticides.length || 0;
                        status.textContent = `Status: Found ${resultCount} result(s) for ${selectionText}`;
                        loadMoreBtn.style.display = 'none';
                    })
                    .catch(() => {
                        status.textContent = 'Status: Error loading filtered results';
                    });
            }

            loadMoreBtn.addEventListener('click', () => {
                loadMoreBtn.textContent = 'Loading...';
                filterPage += 1;
                fetch(`/api/filter?crop=${encodeURIComponent(selectedCrop)}&target_type=${encodeURIComponent(selectedTargetType)}&pest=${encodeURIComponent(selectedPest)}&page=${filterPage}&per_page=${filterPerPage}`)
                    .then(r => r.json())
                    .then(data => {
                        const nextBatch = data.pesticides || [];
                        filteredPesticides = filteredPesticides.concat(nextBatch);
                        renderFilteredTable(filteredPesticides);
                        filterHasNext = (data.pagination && data.pagination.has_next) || false;
                        loadMoreBtn.textContent = 'Load more';
                        loadMoreBtn.style.display = filterHasNext ? 'inline-block' : 'none';
                    })
                    .catch(() => {
                        loadMoreBtn.textContent = 'Load more';
                    });
            });

            // Background fetch of remaining pages, then one final global sort + render
            // Background loader removed: we now fetch all results in one request for stable sorting
        }

        function renderFilteredTable(list) {
            const tbody = document.getElementById('filteredPesticidesTableBody');
            tbody.innerHTML = renderGroupedAndSortedTable(list);
        }

        function appendFilteredTable(list) {
            const tbody = document.getElementById('filteredPesticidesTableBody');
            tbody.insertAdjacentHTML('beforeend', renderGroupedAndSortedTable(list));
        }

        function renderGroupedAndSortedTable(list) {
            // Group pesticides by active ingredient
            const groupedByIngredient = {};
            
            list.forEach(pesticide => {
                const ingredients = (pesticide.active_ingredients || []).map(ing => ing.name).filter(Boolean);
                const ingredientKey = ingredients.length > 0 ? ingredients.join(', ') : 'Unknown';
                
                if (!groupedByIngredient[ingredientKey]) {
                    groupedByIngredient[ingredientKey] = [];
                }
                groupedByIngredient[ingredientKey].push(pesticide);
            });
            
            // Sort groups by mode of action (primary sort) and then by ingredient name (secondary sort)
            const sortedGroups = Object.entries(groupedByIngredient).sort(([ingredientA, pesticidesA], [ingredientB, pesticidesB]) => {
                // Get mode of action for each group
                const moaA = getPrimaryModeOfAction(pesticidesA);
                const moaB = getPrimaryModeOfAction(pesticidesB);
                
                // Custom sorting for mode of action - put "?" at the end
                const sortMoa = (moa) => {
                    if (moa === '?' || moa === 'N/A') return 'zzzzzz'; // Put unknown modes at the end
                    return moa;
                };
                
                const sortMoaA = sortMoa(moaA);
                const sortMoaB = sortMoa(moaB);
                
                // First sort by mode of action
                if (sortMoaA !== sortMoaB) {
                    return sortMoaA.localeCompare(sortMoaB);
                }
                
                // If mode of action is the same, sort by ingredient name
                return ingredientA.localeCompare(ingredientB);
            });
            
            // Render the grouped and sorted table
            let html = '';
            let groupIndex = 0;
            
            sortedGroups.forEach(([ingredient, pesticides]) => {
                const moa = getPrimaryModeOfAction(pesticides);
                const groupId = `group-${groupIndex}`;
                
                if (pesticides.length === 1) {
                    // Single product - show as normal row without expandability
                    const pesticide = pesticides[0];
                    const summaryData = getPesticideSummaryData(pesticide);
                    
                    html += `<tr class="single-product-row">`;
                    html += `<td style="width: 30px;"></td>`;
                    html += `<td class="label-cell" onclick="event.stopPropagation();">
                        <a href="${pesticide.label_url || '#'}" target="_blank" class="label-link-btn" ${!pesticide.label_url ? 'style="pointer-events: none; opacity: 0.5;"' : ''}>
                            üè∑Ô∏è
                        </a>
                    </td>`;
                    html += `<td class="ingredients-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${ingredient}</td>`;
                    html += `<td class="trade-name-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${pesticide.trade_Name}</td>`;
                    html += `<td class="moa-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${moa}</td>`;
                    html += `<td class="rate-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${summaryData.rateDisplay}</td>`;
                    html += `<td class="rei-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${summaryData.reiDisplay}</td>`;
                    html += `<td class="phi-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${summaryData.phiDisplay}</td>`;
                    html += `</tr>`;
                } else {
                    // Multiple products - show as expandable group
                    const firstPesticide = pesticides[0];
                    const summaryData = getPesticideSummaryData(firstPesticide);
                    
                    // Add summary row (collapsed by default)
                    html += `
                        <tr class="ingredient-group-summary collapsed" data-group-id="${groupId}" onclick="toggleGroup('${groupId}')" style="background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                            <td style="width: 30px; text-align: center; padding: 12px 8px;">
                                <span class="collapse-icon">v</span>
                            </td>
                            <td class="label-cell" onclick="event.stopPropagation();">
                                <a href="${firstPesticide.label_url || '#'}" target="_blank" class="label-link-btn" ${!firstPesticide.label_url ? 'style="pointer-events: none; opacity: 0.5;"' : ''}>
                                    üè∑Ô∏è
                                </a>
                            </td>
                            <td class="ingredients-cell" onclick="showPesticideDetails('${firstPesticide.epa_reg_no}')">Generic: ${ingredient}</td>
                            <td class="trade-name-cell" onclick="showPesticideDetails('${firstPesticide.epa_reg_no}')">${firstPesticide.trade_Name}</td>
                            <td class="moa-cell" onclick="showPesticideDetails('${firstPesticide.epa_reg_no}')">${moa}</td>
                            <td class="rate-cell" onclick="showPesticideDetails('${firstPesticide.epa_reg_no}')">${summaryData.rateDisplay}</td>
                            <td class="rei-cell" onclick="showPesticideDetails('${firstPesticide.epa_reg_no}')">${summaryData.reiDisplay}</td>
                            <td class="phi-cell" onclick="showPesticideDetails('${firstPesticide.epa_reg_no}')">${summaryData.phiDisplay}</td>
                        </tr>
                    `;
                    
                    // Add pesticide rows for this ingredient group (collapsed by default)
                    // Skip the first pesticide since it's already shown in the summary row
                    pesticides.slice(1).forEach(pesticide => {
                        html += `<tr class="ingredient-group-content collapsed" data-group-id="${groupId}">`;
                        html += `<td style="width: 30px;"></td>`;
                        html += renderPesticideRow(pesticide);
                        html += `</tr>`;
                    });
                }
                
                groupIndex++;
            });
            
            return html;
        }

        function getPrimaryModeOfAction(pesticides) {
            // Get the most common mode of action from the group
            const moaCounts = {};
            
            pesticides.forEach(pesticide => {
                const moaSet = new Set((pesticide.active_ingredients || []).map(ing => (ing.mode_Of_Action || '?')).filter(Boolean));
                const moa = Array.from(moaSet).filter(v => v && v !== '?' && v !== 'N/A').join(', ') || '?';
                moaCounts[moa] = (moaCounts[moa] || 0) + 1;
            });
            
            // Return the most common mode of action, or the first one if tied
            const sortedMoa = Object.entries(moaCounts).sort((a, b) => b[1] - a[1]);
            return sortedMoa.length > 0 ? sortedMoa[0][0] : '?';
        }

        function getPesticideSummaryData(pesticide) {
            // Extract specific rate, PHI, and REI for the selected crop and target
            let rateDisplay = 'N/A';
            let phiDisplay = 'N/A';
            let reiDisplay = 'N/A';
            
            if (pesticide.application_info && pesticide.application_info.length > 0) {
                // Find applications that match the selected crop and target
                const matchingApps = pesticide.application_info.filter(app => {
                    // Check if selected crop is contained within the comma-separated crop string
                    let cropMatch = !selectedCrop;
                    if (selectedCrop && app.Target_Crop) {
                        const cropList = app.Target_Crop.split(',').map(c => c.trim());
                        
                        // More flexible matching to handle normalization differences
                        cropMatch = cropList.some(crop => {
                            // Direct match
                            if (crop === selectedCrop) return true;
                            
                            // Case-insensitive match
                            if (crop.toLowerCase() === selectedCrop.toLowerCase()) return true;
                            
                            // Check if one contains the other (for partial matches)
                            const selectedLower = selectedCrop.toLowerCase();
                            const cropLower = crop.toLowerCase();
                            if (cropLower.includes(selectedLower) || selectedLower.includes(cropLower)) return true;
                            
                            return false;
                        });
                    }
                    
                    // Check if selected pest is contained within the comma-separated pest string
                    let pestMatch = !selectedPest;
                    if (selectedPest && app.Target_Disease_Pest) {
                        const pestList = app.Target_Disease_Pest.split(',').map(p => p.trim());
                        
                        // More flexible matching to handle normalization differences
                        pestMatch = pestList.some(pest => {
                            // Direct match
                            if (pest === selectedPest) return true;
                            
                            // Case-insensitive match
                            if (pest.toLowerCase() === selectedPest.toLowerCase()) return true;
                            
                            // Handle plural/singular variations
                            const selectedLower = selectedPest.toLowerCase();
                            const pestLower = pest.toLowerCase();
                            
                            // Check if one is plural and one is singular
                            if (selectedLower.endsWith('s') && !pestLower.endsWith('s')) {
                                if (selectedLower.slice(0, -1) === pestLower) return true;
                            } else if (!selectedLower.endsWith('s') && pestLower.endsWith('s')) {
                                if (selectedLower === pestLower.slice(0, -1)) return true;
                            }
                            
                            // Check if one contains the other (for partial matches)
                            if (pestLower.includes(selectedLower) || selectedLower.includes(pestLower)) return true;
                            
                            return false;
                        });
                    }
                    
                    return cropMatch && pestMatch;
                });
                
                if (matchingApps.length > 0) {
                    // Get rate information
                    const rates = matchingApps.map(app => {
                        if (app.low_rate && app.high_rate && app.low_rate !== 'N/A' && app.high_rate !== 'N/A') {
                            const units = app.units || '';
                            if (app.low_rate === app.high_rate) {
                                return `${app.low_rate} ${units}`;
                            } else {
                                return `${app.low_rate}-${app.high_rate} ${units}`;
                            }
                        } else if (app.low_rate && app.low_rate !== 'N/A') {
                            return `${app.low_rate} ${app.units || ''}`;
                        } else if (app.high_rate && app.high_rate !== 'N/A') {
                            return `${app.high_rate} ${app.units || ''}`;
                        }
                        return null;
                    }).filter(Boolean);
                    
                    if (rates.length > 0) {
                        // Check if there are multiple different rates
                        const uniqueRates = [...new Set(rates)];
                        if (uniqueRates.length > 1) {
                            rateDisplay = 'Multiple, Click for details';
                        } else {
                            rateDisplay = rates[0]; // Use first matching rate if all are the same
                        }
                    }
                    
                    // Get PHI information
                    const phis = matchingApps.map(app => app.PHI).filter(phi => phi && phi !== 'N/A');
                    if (phis.length > 0) {
                        phiDisplay = phis[0]; // Use first matching PHI
                    }
                    
                    // Apply the same N/A replacement logic as in modal view
                    if (phiDisplay === 'N/A') {
                        phiDisplay = '?';
                    }
                    
                    // Get REI information from matching applications
                    const reis = matchingApps.map(app => app.REI).filter(rei => rei && rei !== 'N/A');
                    
                    if (reis.length > 0) {
                        // Check if there are multiple different REI values
                        const uniqueReis = [...new Set(reis)];
                        if (uniqueReis.length > 1) {
                            reiDisplay = 'Multiple';
                        } else {
                            reiDisplay = reis[0]; // Use first matching REI if all are the same
                        }
                    }
                    
                    // Apply the same N/A replacement logic as in modal view
                    if (reiDisplay === 'N/A') {
                        reiDisplay = '?';
                    }
                }
            }
            
            return {
                rateDisplay,
                phiDisplay,
                reiDisplay
            };
        }

        function toggleGroup(groupId) {
            const summary = document.querySelector(`[data-group-id="${groupId}"].ingredient-group-summary`);
            const contentRows = document.querySelectorAll(`[data-group-id="${groupId}"].ingredient-group-content`);
            
            if (summary && contentRows.length > 0) {
                const isCollapsed = summary.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand
                    summary.classList.remove('collapsed');
                    contentRows.forEach(row => row.classList.remove('collapsed'));
                } else {
                    // Collapse
                    summary.classList.add('collapsed');
                    contentRows.forEach(row => row.classList.add('collapsed'));
                }
            }
        }

        function renderPesticideRow(pesticide) {
            const moaSet = new Set((pesticide.active_ingredients || []).map(ing => (ing.mode_Of_Action || '?')).filter(Boolean));
            const moa = Array.from(moaSet).filter(v => v && v !== '?' && v !== 'N/A').join(', ') || '?';

            // Extract specific rate, PHI, and REI for the selected crop and target
            let rateDisplay = 'N/A';
            let phiDisplay = 'N/A';
            let reiDisplay = 'N/A';
            
            if (pesticide.application_info && pesticide.application_info.length > 0) {
                // Find applications that match the selected crop and target
                const matchingApps = pesticide.application_info.filter(app => {
                    // Check if selected crop is contained within the comma-separated crop string
                    let cropMatch = !selectedCrop;
                    if (selectedCrop && app.Target_Crop) {
                        const cropList = app.Target_Crop.split(',').map(c => c.trim());
                        
                        // More flexible matching to handle normalization differences
                        cropMatch = cropList.some(crop => {
                            // Direct match
                            if (crop === selectedCrop) return true;
                            
                            // Case-insensitive match
                            if (crop.toLowerCase() === selectedCrop.toLowerCase()) return true;
                            
                            // Check if one contains the other (for partial matches)
                            const selectedLower = selectedCrop.toLowerCase();
                            const cropLower = crop.toLowerCase();
                            if (cropLower.includes(selectedLower) || selectedLower.includes(cropLower)) return true;
                            
                            return false;
                        });
                    }
                    
                    // Check if selected pest is contained within the comma-separated pest string
                    let pestMatch = !selectedPest;
                    if (selectedPest && app.Target_Disease_Pest) {
                        const pestList = app.Target_Disease_Pest.split(',').map(p => p.trim());
                        
                        // More flexible matching to handle normalization differences
                        pestMatch = pestList.some(pest => {
                            // Direct match
                            if (pest === selectedPest) return true;
                            
                            // Case-insensitive match
                            if (pest.toLowerCase() === selectedPest.toLowerCase()) return true;
                            
                            // Handle plural/singular variations
                            const selectedLower = selectedPest.toLowerCase();
                            const pestLower = pest.toLowerCase();
                            
                            // Check if one is plural and one is singular
                            if (selectedLower.endsWith('s') && !pestLower.endsWith('s')) {
                                if (selectedLower.slice(0, -1) === pestLower) return true;
                            } else if (!selectedLower.endsWith('s') && pestLower.endsWith('s')) {
                                if (selectedLower === pestLower.slice(0, -1)) return true;
                            }
                            
                            // Check if one contains the other (for partial matches)
                            if (pestLower.includes(selectedLower) || selectedLower.includes(pestLower)) return true;
                            
                            return false;
                        });
                    }
                    
                    return cropMatch && pestMatch;
                });
                
                if (matchingApps.length > 0) {
                    // Get rate information
                    const rates = matchingApps.map(app => {
                        if (app.low_rate && app.high_rate && app.low_rate !== 'N/A' && app.high_rate !== 'N/A') {
                            const units = app.units || '';
                            if (app.low_rate === app.high_rate) {
                                return `${app.low_rate} ${units}`;
                            } else {
                                return `${app.low_rate}-${app.high_rate} ${units}`;
                            }
                        } else if (app.low_rate && app.low_rate !== 'N/A') {
                            return `${app.low_rate} ${app.units || ''}`;
                        } else if (app.high_rate && app.high_rate !== 'N/A') {
                            return `${app.high_rate} ${app.units || ''}`;
                        }
                        return null;
                    }).filter(Boolean);
                    
                    if (rates.length > 0) {
                        // Check if there are multiple different rates
                        const uniqueRates = [...new Set(rates)];
                        if (uniqueRates.length > 1) {
                            rateDisplay = 'Multiple';
                        } else {
                            rateDisplay = rates[0]; // Use first matching rate if all are the same
                        }
                    }
                    
                    // Get PHI information
                    const phis = matchingApps.map(app => app.PHI).filter(phi => phi && phi !== 'N/A');
                    if (phis.length > 0) {
                        phiDisplay = phis[0]; // Use first matching PHI
                    }
                    
                    // Apply the same N/A replacement logic as in modal view
                    if (phiDisplay === 'N/A') {
                        phiDisplay = '?';
                    }
                    
                    // Get REI information from matching applications
                    const reis = matchingApps.map(app => app.REI).filter(rei => rei && rei !== 'N/A');
                    
                    if (reis.length > 0) {
                        // Check if there are multiple different REI values
                        const uniqueReis = [...new Set(reis)];
                        if (uniqueReis.length > 1) {
                            reiDisplay = 'Multiple';
                        } else {
                            reiDisplay = reis[0]; // Use first matching REI if all are the same
                        }
                    }
                    
                    // Apply the same N/A replacement logic as in modal view
                    if (reiDisplay === 'N/A') {
                        reiDisplay = '?';
                    }
                }
            }
            
            return `
                    <td class="label-cell" onclick="event.stopPropagation();">
                        <a href="${pesticide.label_url || '#'}" target="_blank" class="label-link-btn" ${!pesticide.label_url ? 'style="pointer-events: none; opacity: 0.5;"' : ''}>
                            üè∑Ô∏è
                        </a>
                    </td>
                    <td class="ingredients-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${(pesticide.active_ingredients||[]).map(ing => ing.name).join(', ') || 'N/A'}</td>
                    <td class="trade-name-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${pesticide.trade_Name}</td>
                    <td class="moa-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${moa}</td>
                    <td class="rate-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${rateDisplay}</td>
                    <td class="rei-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${reiDisplay}</td>
                    <td class="phi-cell" onclick="showPesticideDetails('${pesticide.epa_reg_no}')">${phiDisplay}</td>`;
        }

        function downloadFilteredResults() {
            // Get current filter values
            const selectedCrop = window.selectedCrop || '';
            const selectedTargetType = window.selectedTargetType || '';
            const selectedPest = window.selectedPest || '';
            
            // Check if filters are applied
            if (!selectedCrop && !selectedTargetType && !selectedPest) {
                alert('Please apply filters first before downloading results.');
                return;
            }
            
            // Build the download URL with current filter parameters
            let downloadUrl = '/api/filter/download?';
            const params = [];
            
            if (selectedCrop) {
                params.push(`crop=${encodeURIComponent(selectedCrop)}`);
            }
            if (selectedTargetType) {
                params.push(`target_type=${encodeURIComponent(selectedTargetType)}`);
            }
            if (selectedPest) {
                params.push(`pest=${encodeURIComponent(selectedPest)}`);
            }
            
            downloadUrl += params.join('&');
            
            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = ''; // Let the server set the filename
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

</body>
</html> 